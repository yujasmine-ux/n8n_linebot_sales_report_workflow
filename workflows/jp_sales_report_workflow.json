{
  "name": "ç™½åå–®My workflow 8",
  "nodes": [
    {
      "parameters": {
        "functionCode": "const rows = $items().map(item => item.json);\n\n// ä»Šæ—¥æ—¥æœŸ\nconst today = new Date().toISOString().slice(0, 10).replace(/-/g, '');\n\n// éŽæ¿¾ä»Šæ—¥è³‡æ–™\nconst todayRows = rows.filter(r => r[\"éŠ·/é€€æ—¥æœŸ\"] === today);\n\n// ä»Šæ—¥çµ±è¨ˆ\nconst totalRevenue = todayRows.reduce((sum, row) => sum + (parseFloat(row[\"å°è¨ˆ\"]) || 0), 0);\nconst uniqueOrders = new Set(todayRows.map(row => row[\"éŠ·è²¨å–®è™Ÿ\"])).size;\n\n// é–€å¸‚èˆ‡å•†å“çµ±è¨ˆ\nconst stores = {};\nconst products = {};\n\nfor (const row of todayRows) {\n  const store = row[\"é–€å¸‚åç¨±\"]?.trim() || \"æœªçŸ¥é–€å¸‚\";\n  const product = row[\"å•†å“åç¨±\"]?.trim() || \"æœªçŸ¥å•†å“\";\n  const isReturn = row[\"ç‹€æ…‹\"]?.includes(\"é€€\");\n  const qty = parseFloat(row[\"æ•¸é‡\"]) || 0;\n  const amount = parseFloat(row[\"å°è¨ˆ\"]) || 0;\n\n  if (!stores[store]) stores[store] = { count: 0, amount: 0 };\n  stores[store].count += 1;\n  stores[store].amount += amount;\n\n  if (!products[product]) {\n    products[product] = { saleQty: 0, saleAmount: 0, returnQty: 0, returnAmount: 0 };\n  }\n  if (isReturn) {\n    products[product].returnQty += qty;\n    products[product].returnAmount += amount;\n  } else {\n    products[product].saleQty += qty;\n    products[product].saleAmount += amount;\n  }\n}\n\n// éŠ·å”®æŽ’è¡Œ\nconst topProducts = Object.entries(products)\n  .sort((a, b) => b[1].saleAmount - a[1].saleAmount)\n  .slice(0, 3)\n  .map(([name, stat], idx) => `${idx + 1}. ${name}ï¼š${stat.saleAmount.toLocaleString()} å…ƒ`);\n\n// å»ºç«‹è¨Šæ¯é™£åˆ—\nconst summary = [\n  `ðŸ“† ä»Šæ—¥éŠ·å”®æ—¥æœŸï¼š${today.slice(0,4)}/${today.slice(4,6)}/${today.slice(6,8)}`,\n  `ðŸ’° ç‡Ÿæ”¶ç¸½é¡ï¼š${totalRevenue.toLocaleString()} å…ƒ`,\n  `ðŸ“¦ è¨‚å–®ç¸½æ•¸ï¼š${uniqueOrders} ç­†`,\n  \"\",\n  \"ðŸª å„é–€å¸‚éŠ·å”®ï¼š\",\n  ...Object.entries(stores).map(\n    ([store, stat]) => `ðŸ”¹ ${store}: ${stat.amount.toLocaleString()} å…ƒ / ${stat.count} ç­†`\n  ),\n  \"\",\n  \"ðŸ† éŠ·å”®æŽ’è¡Œæ¦œï¼ˆä¾é‡‘é¡ï¼‰ï¼š\",\n  ...topProducts\n];\n\n// è¼¸å‡º LINE å›žè¦†æ ¼å¼\nreturn [\n  {\n    json: {\n      replyToken: $json.replyToken,\n      messageText: summary.join('\\n')\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -60,
        -60
      ],
      "name": "[Function] çµ±è¨ˆèˆ‡çµ„æˆè¨Šæ¯",
      "id": "bcfa5a31-bc29-4ee0-94d4-5d8cc47e9463"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DECLARE @QueryDate1 DATE = CAST(GETDATE() - 1 AS DATE),\n        @QueryDate2 DATE = CAST(GETDATE() AS DATE);\n\nSELECT *\nFROM F0052\nWHERE DATE1 BETWEEN @QueryDate1 AND @QueryDate2;\n\n(SELECT \n    F0052.OFFNO AS é–€å¸‚ç·¨è™Ÿ, \n    ISNULL(F0058.INVNO, '') AS ç™¼ç¥¨è™Ÿç¢¼, \n    ISNULL(F0058.CARRIERID1, '') AS è¼‰å…·è™Ÿç¢¼, \n    F0052.DATE1 AS 'éŠ·/é€€æ—¥æœŸ', \n    'éŠ·å”®' AS ç‹€æ…‹, \n    F0051.WNO AS æ©Ÿ, \n    F0051.CUSTNO AS æœƒå“¡ç·¨è™Ÿ, \n    ISNULL(F0015.CUSTNA, '') AS æœƒå“¡åç¨±, \n    ISNULL(F0015.MOBILE, '') AS é›»è©±, \n    F0051.CARNO AS 'è»Šè™Ÿ', \n    F0051.TAXID AS çµ±ä¸€ç·¨è™Ÿ, \n    F0051.INTRNO AS ä»‹ç´¹äºº, \n    ISNULL(F0066.INTRNA, '') AS ä»‹ç´¹äººå§“å, \n    F0065.SURNA AS å®¢æˆ¶ä¾†æº, \n    F0049.SERNA AS 'æœå‹™å¤§é¡ž', \n    F0002.KIND1C AS å¤§é¡žåç¨±, \n    F0001.PRNO AS å•†å“ç·¨è™Ÿ, \n    F0001.PRNA AS å•†å“åç¨±, \n    'æ‡‰ç¨…' AS ç¨…åˆ¥, \n    F0052.MONEY1 AS å–®åƒ¹, \n    F0052.QTY1 AS æ•¸é‡, \n    F0052.BPER AS æŠ˜æ‰£çŽ‡, \n    F0052.MONEY1 * F0052.QTY1 AS å°è¨ˆ,\n    (SELECT STNA FROM F0014 AS f14 WHERE f14.STNO = F0051.STNO1) AS éŠ·å”®å“¡å·¥, \n    ISNULL((SELECT STNA FROM F0014 AS f14 WHERE f14.STNO = F0051.STNO2), '') AS é€€è²¨å“¡å·¥, \n    F0052.SALNO AS éŠ·è²¨å–®è™Ÿ, \n    ISNULL(F0015.NOTE1, '') AS æœƒå“¡å‚™è¨», \n    F0051.NOTE2 AS è¨‚å–®å‚™è¨», \n    F0004.OFFNA AS é–€å¸‚åç¨±\nFROM F0052 \n    LEFT OUTER JOIN F0051 ON F0051.SALNO = F0052.SALNO \n    LEFT OUTER JOIN F0058 ON F0058.SALNO = F0052.SALNO \n    LEFT OUTER JOIN F0066 ON F0051.INTRNO = F0066.INTRNO \n    LEFT OUTER JOIN F0015 ON F0015.CUSTNO = F0051.CUSTNO \n    LEFT OUTER JOIN F0001 ON F0001.PRNO = F0052.PRNO \n    LEFT OUTER JOIN F0002 ON F0002.KIND1 = F0001.KIND1 AND F0002.KIND0 = '2' \n    LEFT OUTER JOIN F0004 ON F0052.OFFNO = F0004.OFFNO\n    LEFT JOIN F0065 ON F0065.SURNO = F0051.SURNO\n    LEFT JOIN F0049 ON F0049.SERNO = F0051.SERNO\nWHERE F0052.DATE1 >= @QueryDate1 AND F0052.DATE1 <= @QueryDate2\nUNION ALL\nSELECT \n    F0052.OFFNO AS é–€å¸‚ç·¨è™Ÿ, \n    ISNULL(F0058.INVNO, '') AS ç™¼ç¥¨è™Ÿç¢¼, \n    ISNULL(F0058.CARRIERID1, '') AS è¼‰å…·è™Ÿç¢¼, \n    F0052.DATE2 AS 'éŠ·/é€€æ—¥æœŸ', \n    'éŠ·é€€' AS ç‹€æ…‹, \n    F0051.WNO AS æ©Ÿ, \n    F0051.CUSTNO AS æœƒå“¡ç·¨è™Ÿ, \n    ISNULL(F0015.CUSTNA, '') AS æœƒå“¡åç¨±, \n    ISNULL(F0015.MOBILE, '') AS é›»è©±, \n    F0051.CARNO AS 'è»Šè™Ÿ', \n    F0051.TAXID AS çµ±ä¸€ç·¨è™Ÿ, \n    F0051.INTRNO AS ä»‹ç´¹äºº, \n    ISNULL(F0066.INTRNA, '') AS ä»‹ç´¹äººå§“å, \n    F0065.SURNA AS å®¢æˆ¶ä¾†æº, \n    F0049.SERNA AS 'æœå‹™å¤§é¡ž', \n    F0002.KIND1C AS å¤§é¡žåç¨±, \n    F0001.PRNO AS å•†å“ç·¨è™Ÿ, \n    F0001.PRNA AS å•†å“åç¨±, \n    'æ‡‰ç¨…' AS ç¨…åˆ¥, \n    F0052.MONEY1 AS å–®åƒ¹, \n    -F0052.QTY1 AS æ•¸é‡, \n    F0052.BPER AS æŠ˜æ‰£çŽ‡, \n    F0052.MONEY1 * (-F0052.QTY1) AS å°è¨ˆ,\n    (SELECT STNA FROM F0014 AS f14 WHERE f14.STNO = F0051.STNO1) AS éŠ·å”®å“¡å·¥, \n    ISNULL((SELECT STNA FROM F0014 AS f14 WHERE f14.STNO = F0051.STNO2), '') AS é€€è²¨å“¡å·¥, \n    F0052.SALNO AS éŠ·è²¨å–®è™Ÿ, \n    ISNULL(F0015.NOTE1, '') AS æœƒå“¡å‚™è¨», \n    F0051.NOTE2 AS è¨‚å–®å‚™è¨», \n    F0004.OFFNA AS é–€å¸‚åç¨±\nFROM F0052 \n    LEFT OUTER JOIN F0051 ON F0051.SALNO = F0052.SALNO \n    LEFT OUTER JOIN F0058 ON F0058.SALNO = F0052.SALNO \n    LEFT OUTER JOIN F0066 ON F0051.INTRNO = F0066.INTRNO \n    LEFT OUTER JOIN F0015 ON F0015.CUSTNO = F0051.CUSTNO \n    LEFT OUTER JOIN F0001 ON F0001.PRNO = F0052.PRNO \n    LEFT OUTER JOIN F0002 ON F0002.KIND1 = F0001.KIND1 AND F0002.KIND0 = '2' \n    LEFT OUTER JOIN F0004 ON F0052.OFFNO = F0004.OFFNO\n    LEFT JOIN F0065 ON F0065.SURNO = F0051.SURNO\n    LEFT JOIN F0049 ON F0049.SERNO = F0051.SERNO\nWHERE F0052.DATE2 >= @QueryDate1 AND F0052.DATE2 <= @QueryDate2)\nORDER BY [éŠ·/é€€æ—¥æœŸ];"
      },
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1.1,
      "position": [
        -240,
        -60
      ],
      "name": "[SQL] æŸ¥è©¢ MSSQL æ¥­ç¸¾å ±è¡¨",
      "id": "fdd55501-17f6-4387-b7db-ea44d69f885c",
      "credentials": {
        "microsoftSql": {
          "id": "DrgwzkTpiUUyiwK5",
          "name": "ç¸½å…¬å¸æ¬Šé™"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replyToken\": \"{{ $('[Function] æ“·å–è¨Šæ¯èˆ‡å„²å­˜å›žè¦† token').first().json.replyToken }}\",\n  \"messages\": {{ JSON.stringify($json.replyMessages) }}\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        400,
        -260
      ],
      "name": "[LINE] å›žè¦†æ¥­ç¸¾è¨Šæ¯",
      "id": "3dc88494-ce4a-4ee1-b3fa-edf477813045",
      "credentials": {
        "httpHeaderAuth": {
          "id": "9pqIVfx96m4VR0F3",
          "name": "lineapi"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.messageText }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        20,
        140
      ],
      "id": "19cdc9f0-b356-48ac-9205-216993465159",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "cityName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('City', `Cityå¿…é ˆè½‰æˆè‹±æ–‡`, 'string') }}",
        "language": "zh-tw"
      },
      "type": "n8n-nodes-base.openWeatherMapTool",
      "typeVersion": 1,
      "position": [
        220,
        400
      ],
      "id": "f6389a18-bc8a-4408-a6bd-c317be449afb",
      "name": "OpenWeatherMap1",
      "credentials": {
        "openWeatherMapApi": {
          "id": "dnRqbJvjcorXokit",
          "name": "OpenWeatherMap account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-lite-preview-06-17",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        40,
        400
      ],
      "id": "3e4c42a2-77b7-486b-a3fb-08fef8874ff1",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "R3U4r1RXFgV8BVwp",
          "name": "Google Gemini(PaLM) Api account 3"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replyToken\": \"{{ $('[Function] æ“·å–è¨Šæ¯èˆ‡å„²å­˜å›žè¦† token').first().json.replyToken }}\",\n  \"messages\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"{{ $('AI Agent').first().json.output }}\"\n    }\n  ]\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        500,
        180
      ],
      "name": "[LINE] å›žè¦†éžé—œéµè©žè¨Šæ¯",
      "id": "2e598682-25d0-4097-8b7d-33bf5d22a377",
      "credentials": {
        "httpHeaderAuth": {
          "id": "9pqIVfx96m4VR0F3",
          "name": "lineapi"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "if (!$json.replyToken) {\n  throw new Error(\"ç„¡æ³•å–å¾— replyTokenï¼Œè«‹ç¢ºèªä¸Šä¸€å€‹ç¯€é»žçš„è¼¸å‡ºçµæ§‹æ˜¯å¦æ­£ç¢ºã€‚\");\n}\n\nreturn [{\n  json: {\n    replyToken: $json.replyToken,\n    messageText: `è«‹è¼¸å…¥ã€Žæ¥­ç¸¾å ±è¡¨ã€æŸ¥è©¢ï¼Œæˆ–èªªæ˜Žæ‚¨æƒ³çŸ¥é“çš„å…§å®¹ï¼Œä¾‹å¦‚ã€Žå¤©æ°£ã€ã€‚`\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -220,
        180
      ],
      "name": "[Function] éžé—œéµè©žé è¨­å›žè¦†",
      "id": "5c879ee3-f798-4c17-bb80-a37fb345e739"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.messageText }}",
              "value2": "æ¥­ç¸¾å ±è¡¨"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -480,
        60
      ],
      "name": "[IF] æ˜¯å¦ç‚º 'æ¥­ç¸¾å ±è¡¨'",
      "id": "24f4e238-e6ee-4bc5-a150-5c9fdf3f41c1"
    },
    {
      "parameters": {
        "functionCode": "const event = $json.body?.events?.[0] || {};\nreturn [{\n  json: {\n    replyToken: event.replyToken,\n    messageText: event.message?.text || ''\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -680,
        60
      ],
      "name": "[Function] æ“·å–è¨Šæ¯èˆ‡å„²å­˜å›žè¦† token",
      "id": "82e27c63-4e2a-4f69-854d-cd1663664ed2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "line-webhook",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -900,
        60
      ],
      "name": "[Webhook] æŽ¥æ”¶ LINE è«‹æ±‚",
      "id": "90bac319-4f03-49bd-85e1-7fb1e3060dca",
      "webhookId": "line-webhook-id"
    },
    {
      "parameters": {
        "functionCode": "const fullText = $json.messageText || '';\nconst MAX_LEN = 2000;\n\nconst segments = [];\nfor (let i = 0; i < fullText.length; i += MAX_LEN) {\n  segments.push({\n    type: 'text',\n    text: fullText.slice(i, i + MAX_LEN)\n  });\n}\n\nreturn {\n  replyMessages: segments.slice(0, 5),\n  pushMessages: segments.slice(5)\n};\n"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        160,
        -260
      ],
      "name": "[Function]åˆ†æ®µè¨Šæ¯",
      "id": "12709e0c-9ce6-4635-89ed-9452a0c7e0c2"
    }
  ],
  "pinData": {},
  "connections": {
    "[Function] çµ±è¨ˆèˆ‡çµ„æˆè¨Šæ¯": {
      "main": [
        [
          {
            "node": "[Function]åˆ†æ®µè¨Šæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[SQL] æŸ¥è©¢ MSSQL æ¥­ç¸¾å ±è¡¨": {
      "main": [
        [
          {
            "node": "[Function] çµ±è¨ˆèˆ‡çµ„æˆè¨Šæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "[LINE] å›žè¦†éžé—œéµè©žè¨Šæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenWeatherMap1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "[Function] éžé—œéµè©žé è¨­å›žè¦†": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[IF] æ˜¯å¦ç‚º 'æ¥­ç¸¾å ±è¡¨'": {
      "main": [
        [
          {
            "node": "[SQL] æŸ¥è©¢ MSSQL æ¥­ç¸¾å ±è¡¨",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "[Function] éžé—œéµè©žé è¨­å›žè¦†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[Function] æ“·å–è¨Šæ¯èˆ‡å„²å­˜å›žè¦† token": {
      "main": [
        [
          {
            "node": "[IF] æ˜¯å¦ç‚º 'æ¥­ç¸¾å ±è¡¨'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[Webhook] æŽ¥æ”¶ LINE è«‹æ±‚": {
      "main": [
        [
          {
            "node": "[Function] æ“·å–è¨Šæ¯èˆ‡å„²å­˜å›žè¦† token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[Function]åˆ†æ®µè¨Šæ¯": {
      "main": [
        [
          {
            "node": "[LINE] å›žè¦†æ¥­ç¸¾è¨Šæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "[LINE] å›žè¦†æ¥­ç¸¾è¨Šæ¯": {
      "main": [
        []
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c9aa5b27-fbd3-4407-9349-458cab84a848",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "258b459c1f0a0a24ea42487c9f57f845106a0c6e3e08b4efa1613f3c80e33eb8"
  },
  "id": "CCQU7cij9nyr9B46",
  "tags": []
}